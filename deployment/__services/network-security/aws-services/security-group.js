"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.createSecurityGroup = void 0;
const aws_ec2_1 = require("aws-cdk-lib/aws-ec2");
const constants_1 = require("../../../constants");
const createSecurityGroup = (scope, props) => {
    var _a, _b;
    const internetPort = getInternetPort(props);
    const portType = getInternetPortType(props);
    const securityGroup = new aws_ec2_1.SecurityGroup(scope, props.identifier, {
        vpc: props.vpc,
        description: props.description,
        allowAllOutbound: false,
    });
    const allowAllRule = [
        aws_ec2_1.Peer.anyIpv4(),
        aws_ec2_1.Port.tcp(internetPort),
        `Allow ${portType} access from the public internet`,
    ];
    const allowAllVpcRule = [
        aws_ec2_1.Peer.ipv4(props.vpc.vpcCidrBlock),
        aws_ec2_1.Port.tcp(internetPort),
        `Allow ${portType} access from within this vpc`,
    ];
    if (typeof props.internetAccess === 'string') {
        if (props.internetAccess === 'allow-all-http' ||
            props.internetAccess === 'allow-all-https') {
            securityGroup.addEgressRule(...allowAllRule);
            securityGroup.addIngressRule(...allowAllRule);
        }
        if (props.internetAccess === 'allow-all-http-in-vpc' ||
            props.internetAccess === 'allow-all-https-in-vpc') {
            securityGroup.addEgressRule(...allowAllVpcRule);
            securityGroup.addIngressRule(...allowAllVpcRule);
        }
    }
    const { sshAccess } = props;
    if (typeof sshAccess === 'string') {
        Object.values(constants_1.DEVELOPERS).forEach((info) => {
            securityGroup.addIngressRule(aws_ec2_1.Peer.ipv4(info.ipAddress + '/32'), aws_ec2_1.Port.tcp(22), `Allow SSH access for an individual at network ${info.name}`);
        });
    }
    if (typeof sshAccess === 'object') {
        (_a = sshAccess === null || sshAccess === void 0 ? void 0 : sshAccess.allowedIpAddresses) === null || _a === void 0 ? void 0 : _a.forEach((ipAddress) => {
            securityGroup.addIngressRule(aws_ec2_1.Peer.ipv4(ipAddress + '/32'), aws_ec2_1.Port.tcp(22), `Allow SSH access for an individual at network ${ipAddress}`);
        });
        (_b = sshAccess === null || sshAccess === void 0 ? void 0 : sshAccess.allowedDevelopers) === null || _b === void 0 ? void 0 : _b.forEach((developer) => {
            const info = constants_1.DEVELOPERS[developer];
            securityGroup.addIngressRule(aws_ec2_1.Peer.ipv4(info.ipAddress + '/32'), aws_ec2_1.Port.tcp(22), `Allow SSH access for an individual at network ${info.name}`);
        });
    }
    return securityGroup;
};
exports.createSecurityGroup = createSecurityGroup;
const getInternetPort = ({ internetAccess }) => {
    if (typeof internetAccess === 'string') {
        return internetAccess.includes('https') ? 443 : 80;
    }
    return (internetAccess === null || internetAccess === void 0 ? void 0 : internetAccess.ssl) ? 443 : 80;
};
const getInternetPortType = ({ internetAccess }) => {
    if (!internetAccess)
        return 'http';
    if (typeof internetAccess === 'string')
        return 'http';
    return internetAccess.ssl ? 'https' : 'http';
};
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VjdXJpdHktZ3JvdXAuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzZWN1cml0eS1ncm91cC50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOzs7QUFDQSxpREFBb0U7QUFFcEUsa0RBQStDO0FBOEJ4QyxNQUFNLG1CQUFtQixHQUFHLENBQUMsS0FBZ0IsRUFBRSxLQUFZLEVBQUUsRUFBRTs7SUFDcEUsTUFBTSxZQUFZLEdBQUcsZUFBZSxDQUFDLEtBQUssQ0FBQyxDQUFBO0lBQzNDLE1BQU0sUUFBUSxHQUFHLG1CQUFtQixDQUFDLEtBQUssQ0FBQyxDQUFBO0lBRTNDLE1BQU0sYUFBYSxHQUFHLElBQUksdUJBQWEsQ0FBQyxLQUFLLEVBQUUsS0FBSyxDQUFDLFVBQVUsRUFBRTtRQUMvRCxHQUFHLEVBQUUsS0FBSyxDQUFDLEdBQUc7UUFDZCxXQUFXLEVBQUUsS0FBSyxDQUFDLFdBQVc7UUFDOUIsZ0JBQWdCLEVBQUUsS0FBSztLQUN4QixDQUFDLENBQUE7SUFFRixNQUFNLFlBQVksR0FBRztRQUNuQixjQUFJLENBQUMsT0FBTyxFQUFFO1FBQ2QsY0FBSSxDQUFDLEdBQUcsQ0FBQyxZQUFZLENBQUM7UUFDdEIsU0FBUyxRQUFRLGtDQUFrQztLQUMzQyxDQUFBO0lBQ1YsTUFBTSxlQUFlLEdBQUc7UUFDdEIsY0FBSSxDQUFDLElBQUksQ0FBQyxLQUFLLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztRQUNqQyxjQUFJLENBQUMsR0FBRyxDQUFDLFlBQVksQ0FBQztRQUN0QixTQUFTLFFBQVEsOEJBQThCO0tBQ3ZDLENBQUE7SUFFVixJQUFJLE9BQU8sS0FBSyxDQUFDLGNBQWMsS0FBSyxRQUFRLEVBQUU7UUFDNUMsSUFDRSxLQUFLLENBQUMsY0FBYyxLQUFLLGdCQUFnQjtZQUN6QyxLQUFLLENBQUMsY0FBYyxLQUFLLGlCQUFpQixFQUMxQztZQUNBLGFBQWEsQ0FBQyxhQUFhLENBQUMsR0FBRyxZQUFZLENBQUMsQ0FBQTtZQUM1QyxhQUFhLENBQUMsY0FBYyxDQUFDLEdBQUcsWUFBWSxDQUFDLENBQUE7U0FDOUM7UUFFRCxJQUNFLEtBQUssQ0FBQyxjQUFjLEtBQUssdUJBQXVCO1lBQ2hELEtBQUssQ0FBQyxjQUFjLEtBQUssd0JBQXdCLEVBQ2pEO1lBQ0EsYUFBYSxDQUFDLGFBQWEsQ0FBQyxHQUFHLGVBQWUsQ0FBQyxDQUFBO1lBQy9DLGFBQWEsQ0FBQyxjQUFjLENBQUMsR0FBRyxlQUFlLENBQUMsQ0FBQTtTQUNqRDtLQUNGO0lBRUQsTUFBTSxFQUFFLFNBQVMsRUFBRSxHQUFHLEtBQUssQ0FBQTtJQUMzQixJQUFJLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRTtRQUNqQyxNQUFNLENBQUMsTUFBTSxDQUFDLHNCQUFVLENBQUMsQ0FBQyxPQUFPLENBQUMsQ0FBQyxJQUFJLEVBQUUsRUFBRTtZQUN6QyxhQUFhLENBQUMsY0FBYyxDQUMxQixjQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLEVBQ2pDLGNBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQ1osaURBQWlELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FDN0QsQ0FBQTtRQUNILENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFDRCxJQUFJLE9BQU8sU0FBUyxLQUFLLFFBQVEsRUFBRTtRQUNqQyxNQUFBLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxrQkFBa0IsMENBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDbkQsYUFBYSxDQUFDLGNBQWMsQ0FDMUIsY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLEVBQzVCLGNBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQ1osaURBQWlELFNBQVMsRUFBRSxDQUM3RCxDQUFBO1FBQ0gsQ0FBQyxDQUFDLENBQUE7UUFDRixNQUFBLFNBQVMsYUFBVCxTQUFTLHVCQUFULFNBQVMsQ0FBRSxpQkFBaUIsMENBQUUsT0FBTyxDQUFDLENBQUMsU0FBUyxFQUFFLEVBQUU7WUFDbEQsTUFBTSxJQUFJLEdBQUcsc0JBQVUsQ0FBQyxTQUFTLENBQUMsQ0FBQTtZQUNsQyxhQUFhLENBQUMsY0FBYyxDQUMxQixjQUFJLENBQUMsSUFBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEdBQUcsS0FBSyxDQUFDLEVBQ2pDLGNBQUksQ0FBQyxHQUFHLENBQUMsRUFBRSxDQUFDLEVBQ1osaURBQWlELElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FDN0QsQ0FBQTtRQUNILENBQUMsQ0FBQyxDQUFBO0tBQ0g7SUFFRCxPQUFPLGFBQWEsQ0FBQTtBQUN0QixDQUFDLENBQUE7QUFwRVksUUFBQSxtQkFBbUIsdUJBb0UvQjtBQUVELE1BQU0sZUFBZSxHQUFHLENBQUMsRUFBRSxjQUFjLEVBQVMsRUFBRSxFQUFFO0lBQ3BELElBQUksT0FBTyxjQUFjLEtBQUssUUFBUSxFQUFFO1FBQ3RDLE9BQU8sY0FBYyxDQUFDLFFBQVEsQ0FBQyxPQUFPLENBQUMsQ0FBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7S0FDbkQ7SUFDRCxPQUFPLENBQUEsY0FBYyxhQUFkLGNBQWMsdUJBQWQsY0FBYyxDQUFFLEdBQUcsRUFBQyxDQUFDLENBQUMsR0FBRyxDQUFDLENBQUMsQ0FBQyxFQUFFLENBQUE7QUFDdkMsQ0FBQyxDQUFBO0FBQ0QsTUFBTSxtQkFBbUIsR0FBRyxDQUFDLEVBQUUsY0FBYyxFQUFTLEVBQUUsRUFBRTtJQUN4RCxJQUFJLENBQUMsY0FBYztRQUFFLE9BQU8sTUFBTSxDQUFBO0lBQ2xDLElBQUksT0FBTyxjQUFjLEtBQUssUUFBUTtRQUFFLE9BQU8sTUFBTSxDQUFBO0lBQ3JELE9BQU8sY0FBYyxDQUFDLEdBQUcsQ0FBQyxDQUFDLENBQUMsT0FBTyxDQUFDLENBQUMsQ0FBQyxNQUFNLENBQUE7QUFDOUMsQ0FBQyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0ICogYXMgZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInXG5pbXBvcnQgeyBQZWVyLCBQb3J0LCBTZWN1cml0eUdyb3VwLCBWcGMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJ1xuaW1wb3J0IHsgQ29uc3RydWN0IH0gZnJvbSAnY29uc3RydWN0cydcbmltcG9ydCB7IERFVkVMT1BFUlMgfSBmcm9tICcuLi8uLi8uLi9jb25zdGFudHMnXG5cbmV4cG9ydCB0eXBlIElwdjRBZGRyZXNzID0gYCR7bnVtYmVyfS4ke251bWJlcn0uJHtudW1iZXJ9LiR7bnVtYmVyfWBcbmV4cG9ydCB0eXBlIENpZHJCbG9jayA9IGAke0lwdjRBZGRyZXNzfS8ke251bWJlcn1gXG5cbnR5cGUgSXBPckRldiA9IElwdjRBZGRyZXNzIHwga2V5b2YgdHlwZW9mIERFVkVMT1BFUlNcblxudHlwZSBpcHY0VHlwZSA9ICdodHRwJyB8ICdodHRwcydcbnR5cGUgSW50ZXJuZXRBbGxvd2FuY2UgPVxuICB8IGBhbGxvdy1hbGwtJHtpcHY0VHlwZX1gXG4gIHwgYGFsbG93LWFsbC0ke2lwdjRUeXBlfS1pbi12cGNgXG50eXBlIFByb3BzID0ge1xuICBpZGVudGlmaWVyOiBzdHJpbmdcbiAgZGVzY3JpcHRpb246IHN0cmluZ1xuICB2cGM6IFZwY1xuICBpbnRlcm5ldEFjY2Vzcz86XG4gICAgfCB7XG4gICAgICAgIHNzbD86IGJvb2xlYW5cbiAgICAgICAgb3V0Ym91bmQ6IHt9IHwgSW50ZXJuZXRBbGxvd2FuY2VcbiAgICAgICAgaW5ib3VuZDoge30gfCBJbnRlcm5ldEFsbG93YW5jZVxuICAgICAgfVxuICAgIHwgSW50ZXJuZXRBbGxvd2FuY2VcbiAgc3NoQWNjZXNzPzpcbiAgICB8IHtcbiAgICAgICAgYWxsb3dlZElwQWRkcmVzc2VzPzogSXB2NEFkZHJlc3NbXVxuICAgICAgICBhbGxvd2VkRGV2ZWxvcGVycz86IChrZXlvZiB0eXBlb2YgREVWRUxPUEVSUylbXVxuICAgICAgfVxuICAgIHwgJ2FsbG93LWFsbC1kZXZlbG9wZXJzJ1xufVxuXG5leHBvcnQgY29uc3QgY3JlYXRlU2VjdXJpdHlHcm91cCA9IChzY29wZTogQ29uc3RydWN0LCBwcm9wczogUHJvcHMpID0+IHtcbiAgY29uc3QgaW50ZXJuZXRQb3J0ID0gZ2V0SW50ZXJuZXRQb3J0KHByb3BzKVxuICBjb25zdCBwb3J0VHlwZSA9IGdldEludGVybmV0UG9ydFR5cGUocHJvcHMpXG5cbiAgY29uc3Qgc2VjdXJpdHlHcm91cCA9IG5ldyBTZWN1cml0eUdyb3VwKHNjb3BlLCBwcm9wcy5pZGVudGlmaWVyLCB7XG4gICAgdnBjOiBwcm9wcy52cGMsXG4gICAgZGVzY3JpcHRpb246IHByb3BzLmRlc2NyaXB0aW9uLFxuICAgIGFsbG93QWxsT3V0Ym91bmQ6IGZhbHNlLFxuICB9KVxuXG4gIGNvbnN0IGFsbG93QWxsUnVsZSA9IFtcbiAgICBQZWVyLmFueUlwdjQoKSxcbiAgICBQb3J0LnRjcChpbnRlcm5ldFBvcnQpLFxuICAgIGBBbGxvdyAke3BvcnRUeXBlfSBhY2Nlc3MgZnJvbSB0aGUgcHVibGljIGludGVybmV0YCxcbiAgXSBhcyBjb25zdFxuICBjb25zdCBhbGxvd0FsbFZwY1J1bGUgPSBbXG4gICAgUGVlci5pcHY0KHByb3BzLnZwYy52cGNDaWRyQmxvY2spLFxuICAgIFBvcnQudGNwKGludGVybmV0UG9ydCksXG4gICAgYEFsbG93ICR7cG9ydFR5cGV9IGFjY2VzcyBmcm9tIHdpdGhpbiB0aGlzIHZwY2AsXG4gIF0gYXMgY29uc3RcblxuICBpZiAodHlwZW9mIHByb3BzLmludGVybmV0QWNjZXNzID09PSAnc3RyaW5nJykge1xuICAgIGlmIChcbiAgICAgIHByb3BzLmludGVybmV0QWNjZXNzID09PSAnYWxsb3ctYWxsLWh0dHAnIHx8XG4gICAgICBwcm9wcy5pbnRlcm5ldEFjY2VzcyA9PT0gJ2FsbG93LWFsbC1odHRwcydcbiAgICApIHtcbiAgICAgIHNlY3VyaXR5R3JvdXAuYWRkRWdyZXNzUnVsZSguLi5hbGxvd0FsbFJ1bGUpXG4gICAgICBzZWN1cml0eUdyb3VwLmFkZEluZ3Jlc3NSdWxlKC4uLmFsbG93QWxsUnVsZSlcbiAgICB9XG5cbiAgICBpZiAoXG4gICAgICBwcm9wcy5pbnRlcm5ldEFjY2VzcyA9PT0gJ2FsbG93LWFsbC1odHRwLWluLXZwYycgfHxcbiAgICAgIHByb3BzLmludGVybmV0QWNjZXNzID09PSAnYWxsb3ctYWxsLWh0dHBzLWluLXZwYydcbiAgICApIHtcbiAgICAgIHNlY3VyaXR5R3JvdXAuYWRkRWdyZXNzUnVsZSguLi5hbGxvd0FsbFZwY1J1bGUpXG4gICAgICBzZWN1cml0eUdyb3VwLmFkZEluZ3Jlc3NSdWxlKC4uLmFsbG93QWxsVnBjUnVsZSlcbiAgICB9XG4gIH1cblxuICBjb25zdCB7IHNzaEFjY2VzcyB9ID0gcHJvcHNcbiAgaWYgKHR5cGVvZiBzc2hBY2Nlc3MgPT09ICdzdHJpbmcnKSB7XG4gICAgT2JqZWN0LnZhbHVlcyhERVZFTE9QRVJTKS5mb3JFYWNoKChpbmZvKSA9PiB7XG4gICAgICBzZWN1cml0eUdyb3VwLmFkZEluZ3Jlc3NSdWxlKFxuICAgICAgICBQZWVyLmlwdjQoaW5mby5pcEFkZHJlc3MgKyAnLzMyJyksXG4gICAgICAgIFBvcnQudGNwKDIyKSxcbiAgICAgICAgYEFsbG93IFNTSCBhY2Nlc3MgZm9yIGFuIGluZGl2aWR1YWwgYXQgbmV0d29yayAke2luZm8ubmFtZX1gLFxuICAgICAgKVxuICAgIH0pXG4gIH1cbiAgaWYgKHR5cGVvZiBzc2hBY2Nlc3MgPT09ICdvYmplY3QnKSB7XG4gICAgc3NoQWNjZXNzPy5hbGxvd2VkSXBBZGRyZXNzZXM/LmZvckVhY2goKGlwQWRkcmVzcykgPT4ge1xuICAgICAgc2VjdXJpdHlHcm91cC5hZGRJbmdyZXNzUnVsZShcbiAgICAgICAgUGVlci5pcHY0KGlwQWRkcmVzcyArICcvMzInKSxcbiAgICAgICAgUG9ydC50Y3AoMjIpLFxuICAgICAgICBgQWxsb3cgU1NIIGFjY2VzcyBmb3IgYW4gaW5kaXZpZHVhbCBhdCBuZXR3b3JrICR7aXBBZGRyZXNzfWAsXG4gICAgICApXG4gICAgfSlcbiAgICBzc2hBY2Nlc3M/LmFsbG93ZWREZXZlbG9wZXJzPy5mb3JFYWNoKChkZXZlbG9wZXIpID0+IHtcbiAgICAgIGNvbnN0IGluZm8gPSBERVZFTE9QRVJTW2RldmVsb3Blcl1cbiAgICAgIHNlY3VyaXR5R3JvdXAuYWRkSW5ncmVzc1J1bGUoXG4gICAgICAgIFBlZXIuaXB2NChpbmZvLmlwQWRkcmVzcyArICcvMzInKSxcbiAgICAgICAgUG9ydC50Y3AoMjIpLFxuICAgICAgICBgQWxsb3cgU1NIIGFjY2VzcyBmb3IgYW4gaW5kaXZpZHVhbCBhdCBuZXR3b3JrICR7aW5mby5uYW1lfWAsXG4gICAgICApXG4gICAgfSlcbiAgfVxuXG4gIHJldHVybiBzZWN1cml0eUdyb3VwXG59XG5cbmNvbnN0IGdldEludGVybmV0UG9ydCA9ICh7IGludGVybmV0QWNjZXNzIH06IFByb3BzKSA9PiB7XG4gIGlmICh0eXBlb2YgaW50ZXJuZXRBY2Nlc3MgPT09ICdzdHJpbmcnKSB7XG4gICAgcmV0dXJuIGludGVybmV0QWNjZXNzLmluY2x1ZGVzKCdodHRwcycpID8gNDQzIDogODBcbiAgfVxuICByZXR1cm4gaW50ZXJuZXRBY2Nlc3M/LnNzbCA/IDQ0MyA6IDgwXG59XG5jb25zdCBnZXRJbnRlcm5ldFBvcnRUeXBlID0gKHsgaW50ZXJuZXRBY2Nlc3MgfTogUHJvcHMpID0+IHtcbiAgaWYgKCFpbnRlcm5ldEFjY2VzcykgcmV0dXJuICdodHRwJ1xuICBpZiAodHlwZW9mIGludGVybmV0QWNjZXNzID09PSAnc3RyaW5nJykgcmV0dXJuICdodHRwJ1xuICByZXR1cm4gaW50ZXJuZXRBY2Nlc3Muc3NsID8gJ2h0dHBzJyA6ICdodHRwJ1xufVxuIl19