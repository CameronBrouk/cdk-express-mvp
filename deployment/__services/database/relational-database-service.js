"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.getDbSecrets = exports.getDbEnvironment = exports.getDbName = exports.getDbSecretJson = exports.createDatabase = void 0;
const ec2 = require("aws-cdk-lib/aws-ec2");
const ecs = require("aws-cdk-lib/aws-ecs");
const rds = require("aws-cdk-lib/aws-rds");
const cdk = require("aws-cdk-lib");
const aws_cdk_lib_1 = require("aws-cdk-lib");
const security_group_1 = require("../network-security/aws-services/security-group");
const createDatabase = (scope, props) => {
    const databaseSecurityGroup = (0, security_group_1.createSecurityGroup)(scope, {
        identifier: 'DatabaseSecurityGroup',
        description: 'Database Security Group',
        vpc: props.vpc,
    });
    const database = new rds.DatabaseInstance(scope, `Database`, {
        // should be true but I'm retarded and
        // will probably need to see the prod db to debug dumbass user problems
        storageEncrypted: false,
        // RDS INSTANCE SETTINGS
        // optional, defaults to m5.large(what the fuck?)
        // You get a single persistent database t3.micro for free under aws free tier
        // t3.micro gives 2 Vcpu and 1 gig of memory
        instanceType: new ec2.InstanceType('t3.micro'),
        // Set as Postgres
        engine: rds.DatabaseInstanceEngine.postgres({
            version: rds.PostgresEngineVersion.VER_14_3, // Most recent version of Postgres(prisma supports it)
        }),
        allowMajorVersionUpgrade: false,
        autoMinorVersionUpgrade: true,
        // You get 20GB of storage under the AWS Free tier
        allocatedStorage: 20,
        multiAz: false,
        storageType: rds.StorageType.GP2,
        removalPolicy: cdk.RemovalPolicy.DESTROY,
        // If we ever fat finger a cdk deploy and delete our database,
        // We want our backups to exist.  Even in dev.
        // Note that, by default, 1 backup is created every day.
        // This backup is also only retained for 1 day,
        deleteAutomatedBackups: false,
        // You get 7 days of free performance data
        performanceInsightRetention: 7,
        enablePerformanceInsights: true,
        // Optional Values are:  1, 5, 10, 15, 30, or 60
        // Note:  This is free until you hit cloudwatch limits
        monitoringInterval: aws_cdk_lib_1.Duration.seconds(30),
        // By default, the log retention is 'Forever'.
        // To keep within the free tier, we set it to 7 days.
        // Performance monitoring should be an active thing you do
        // during peak times.  It's not THAT important to know performance
        // from a year ago.  Mostly you want to look at this when
        // your web application shits the bed because you never bothered to
        // check the logs and didn't notice that you were 1 user away from
        // running out of memory/cpu
        cloudwatchLogsRetention: 7,
        databaseName: props.databaseName,
        vpc: props.vpc,
        securityGroups: [databaseSecurityGroup],
        // The credentials must have a 'username' and 'password' property
        vpcSubnets: {
            // If you don't want a NAT Gateway(which we don't), You must set this.
            // If you don't set this and you set 'natgateways' to zero in your vpc,
            // Everything will shit the bed and it will say 'there are no private networks in your vpc'
            // Fucking amazon bullshit about tricking people into spending money.  fucking dumb.
            subnetType: getSubnetType('public'),
        },
    });
    return database;
};
exports.createDatabase = createDatabase;
const getSubnetType = (type) => {
    const types = ec2.SubnetType;
    if (type === 'private')
        return types.PRIVATE_WITH_EGRESS;
    if (type === 'isolated')
        return types.PRIVATE_ISOLATED;
    return types.PUBLIC;
};
const getDbSecretJson = (database) => (field) => {
    if (!database.secret)
        throw 'No Database Secret Created';
    return ecs.Secret.fromSecretsManager(database.secret, field);
};
exports.getDbSecretJson = getDbSecretJson;
// export const getPrismaConnectionDbUrlFromSecret = (secret: Secret) => {
//   const getSecret = getDbSecretJson(secret)
//   const password = getSecret('password')
//   const username = getSecret('username')
//   const host = getSecret('host')
//   const port = getSecret('port')
//   const identifier = getSecret('dbinstanceidentifier')
//   return `postgresql://${username}:${password}@${host}:${port}/${identifier}?schema=public`
// }
const getDbName = (stackName, stage) => `${stackName}${stage}Database`;
exports.getDbName = getDbName;
const getDbEnvironment = (database, dbName) => {
    const { socketAddress, hostname, port } = database.instanceEndpoint;
    return {
        DB_HOST: hostname,
        DB_PORT: port.toString(),
        DB_SOCKET_ADDRESS: socketAddress,
        DB_NAME: dbName,
    };
};
exports.getDbEnvironment = getDbEnvironment;
const getDbSecrets = (secret) => {
    if (!secret)
        return undefined;
    return {
        DB_USERNAME: ecs.Secret.fromSecretsManager(secret, 'username'),
        DB_PASSWORD: ecs.Secret.fromSecretsManager(secret, 'password'),
    };
};
exports.getDbSecrets = getDbSecrets;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoicmVsYXRpb25hbC1kYXRhYmFzZS1zZXJ2aWNlLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsicmVsYXRpb25hbC1kYXRhYmFzZS1zZXJ2aWNlLnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7OztBQUNBLDJDQUEwQztBQUMxQywyQ0FBMEM7QUFDMUMsMkNBQTBDO0FBRTFDLG1DQUFrQztBQUVsQyw2Q0FBc0M7QUFRdEMsb0ZBQXFGO0FBbUM5RSxNQUFNLGNBQWMsR0FBRyxDQUFDLEtBQWdCLEVBQUUsS0FBWSxFQUFFLEVBQUU7SUFDL0QsTUFBTSxxQkFBcUIsR0FBRyxJQUFBLG9DQUFtQixFQUFDLEtBQUssRUFBRTtRQUN2RCxVQUFVLEVBQUUsdUJBQXVCO1FBQ25DLFdBQVcsRUFBRSx5QkFBeUI7UUFDdEMsR0FBRyxFQUFFLEtBQUssQ0FBQyxHQUFHO0tBQ2YsQ0FBQyxDQUFBO0lBRUYsTUFBTSxRQUFRLEdBQUcsSUFBSSxHQUFHLENBQUMsZ0JBQWdCLENBQUMsS0FBSyxFQUFFLFVBQVUsRUFBRTtRQUMzRCxzQ0FBc0M7UUFDdEMsdUVBQXVFO1FBQ3ZFLGdCQUFnQixFQUFFLEtBQUs7UUFFdkIsd0JBQXdCO1FBQ3hCLGlEQUFpRDtRQUNqRCw2RUFBNkU7UUFDN0UsNENBQTRDO1FBQzVDLFlBQVksRUFBRSxJQUFJLEdBQUcsQ0FBQyxZQUFZLENBQUMsVUFBVSxDQUFDO1FBQzlDLGtCQUFrQjtRQUNsQixNQUFNLEVBQUUsR0FBRyxDQUFDLHNCQUFzQixDQUFDLFFBQVEsQ0FBQztZQUMxQyxPQUFPLEVBQUUsR0FBRyxDQUFDLHFCQUFxQixDQUFDLFFBQVEsRUFBRSxzREFBc0Q7U0FDcEcsQ0FBQztRQUNGLHdCQUF3QixFQUFFLEtBQUs7UUFDL0IsdUJBQXVCLEVBQUUsSUFBSTtRQUM3QixrREFBa0Q7UUFDbEQsZ0JBQWdCLEVBQUUsRUFBRTtRQUNwQixPQUFPLEVBQUUsS0FBSztRQUNkLFdBQVcsRUFBRSxHQUFHLENBQUMsV0FBVyxDQUFDLEdBQUc7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QyxNQUFNLEVBQUUsVUFBVSxDQUFDO1FBQzlELFdBQVcsRUFBRSxHQUFHLENBQUMsTUFBTSxDQUFDLGtCQUFrQixDQUFDLE1BQU0sRUFBRSxVQUFVLENBQUM7S0FDL0QsQ0FBQTtBQUNILENBQUMsQ0FBQTtBQU5ZLFFBQUEsWUFBWSxnQkFNeEIiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgeyBDb25zdHJ1Y3QgfSBmcm9tICdjb25zdHJ1Y3RzJ1xuaW1wb3J0ICogYXMgZWMyIGZyb20gJ2F3cy1jZGstbGliL2F3cy1lYzInXG5pbXBvcnQgKiBhcyBlY3MgZnJvbSAnYXdzLWNkay1saWIvYXdzLWVjcydcbmltcG9ydCAqIGFzIHJkcyBmcm9tICdhd3MtY2RrLWxpYi9hd3MtcmRzJ1xuaW1wb3J0ICogYXMgc2VjcmV0cyBmcm9tICdhd3MtY2RrLWxpYi9hd3Mtc2VjcmV0c21hbmFnZXInXG5pbXBvcnQgKiBhcyBjZGsgZnJvbSAnYXdzLWNkay1saWInXG5pbXBvcnQgeyBQZWVyLCBQb3J0LCBWcGMgfSBmcm9tICdhd3MtY2RrLWxpYi9hd3MtZWMyJ1xuaW1wb3J0IHsgRHVyYXRpb24gfSBmcm9tICdhd3MtY2RrLWxpYidcbmltcG9ydCB7IElTZWNyZXQsIFNlY3JldCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1zZWNyZXRzbWFuYWdlcidcbmltcG9ydCB7IENsb3VkV2F0Y2hMb2dHcm91cCB9IGZyb20gJ2F3cy1jZGstbGliL2F3cy1ldmVudHMtdGFyZ2V0cydcbmltcG9ydCB7XG4gIERhdGFiYXNlSW5zdGFuY2UsXG4gIERhdGFiYXNlSW5zdGFuY2VQcm9wcyxcbiAgRGF0YWJhc2VTZWNyZXQsXG59IGZyb20gJ2F3cy1jZGstbGliL2F3cy1yZHMnXG5pbXBvcnQgeyBjcmVhdGVTZWN1cml0eUdyb3VwIH0gZnJvbSAnLi4vbmV0d29yay1zZWN1cml0eS9hd3Mtc2VydmljZXMvc2VjdXJpdHktZ3JvdXAnXG5pbXBvcnQgeyBJbnN0YW5jZVR5cGVJZGVudGlmaWVyIH0gZnJvbSAnLi4vLi4vdHlwZXMvaW5zdGFuY2UtdHlwZXMnXG5cbi8qKlxuICAtIFNldHRpbmdzXG4gICAgLSBpbnN0YW5jZTogIHQzLm1pY3JvXG4gICAgLSB0eXBlOiBwb3N0Z3Jlc1xuICAtIENyZWRlbnRpYWxzOiBBIEpzb24gc3RyaW5nIHRoYXQgcmVzb2x2ZXMgdG86XG4gICAgLSBcImVuZ2luZVwiOiBcInBvc3RncmVzXCIsXG4gICAgLSBcImhvc3RcIjogXCI8aW5zdGFuY2UgaG9zdCBuYW1lL3Jlc29sdmFibGUgRE5TIG5hbWU+XCIsXG4gICAgLSBcInVzZXJuYW1lXCI6IFwiPHVzZXJuYW1lLiBpZiBub3Qgc3BlY2lmaWVkLCBkZWZhdWx0cyB0byAnYWRtaW4nXCIsXG4gICAgLSBcInBhc3N3b3JkXCI6IFwiPHBhc3N3b3JkLiBnZW5lcmF0ZWQvcm90YXRlZCBieSBhd3Mgc2VjcmV0cyBtYW5hZ2VyXCIsXG4gICAgLSBcImRibmFtZVwiOiBcIjxkYXRhYmFzZSBuYW1lLiBJZiBub3Qgc3BlY2lmaWVkLCBkZWZhdWx0cyB0byAncG9zdGdyZXMnPlwiLFxuICAgIC0gXCJwb3J0XCI6IFwiPFRDUCBwb3J0IG51bWJlci4gSWYgbm90IHNwZWNpZmllZCwgZGVmYXVsdHMgdG8gNTQzMj5cIlxuICAtIENvc3RcbiAgICAtIGZyZWUgdGllcjogICQwL21vXG4gICAgLSBhZnRlcjogJDMwKGlzaCkvbW9cbiAgLSBOZXR3b3JrIFNlY3VyaXR5XG4gICAgLSBPbmx5IGFsbG93cyB0cmFmZmljIGZyb20gd2l0aGluIFZQQyBvbiBQb3J0IDU0MzJcbiAgLSBNb25pdG9yaW5nXG4gICAgLSBib3RoIHBlcmZvcm1hbmNlSW5zaWdodHMgYW5kIGVuaGFuY2VkTW9uaXRvcmluZyBhcmUgc2V0IGJ5IGRlZmF1bHRcbiAgICAtIFwiUGVyZm9ybWFuY2UgSW5zaWdodHNcIiBjaGVja3MgdGhlIGRhdGFiYXNlIGxvYWRcbiAgICAgICAgLSBkb2NzOiBodHRwczovL2RvY3MuYXdzLmFtYXpvbi5jb20vQW1hem9uUkRTL2xhdGVzdC9Vc2VyR3VpZGUvVVNFUl9QZXJmSW5zaWdodHMuaHRtbFxuICAgIC0gXCJFbmhhbmNlZCBNb25pdG9yaW5nXCIgY2hlY2tzIENQVSB1c2FnZSBpbiB0aGUgREIgb3BlcmF0aW5nIFN5c3RlbVxuICAgICAgICAtIGRvY3M6IGh0dHBzOi8vZG9jcy5hd3MuYW1hem9uLmNvbS9BbWF6b25SRFMvbGF0ZXN0L1VzZXJHdWlkZS9VU0VSX01vbml0b3JpbmcuT1MuaHRtbFxuICovXG50eXBlIHN1Ym5ldFR5cGUgPSAncHVibGljJyB8ICdwcml2YXRlJyB8ICdpc29sYXRlZCdcblxudHlwZSBQcm9wcyA9IHtcbiAgaW5zdGFuY2VUeXBlOiBJbnN0YW5jZVR5cGVJZGVudGlmaWVyXG4gIHZwYzogVnBjXG4gIGRhdGFiYXNlTmFtZTogc3RyaW5nXG4gIHN1Ym5ldFR5cGU6IHN1Ym5ldFR5cGVcbiAgb3ZlcnJpZGVzPzogRGF0YWJhc2VJbnN0YW5jZVByb3BzXG59XG5leHBvcnQgY29uc3QgY3JlYXRlRGF0YWJhc2UgPSAoc2NvcGU6IENvbnN0cnVjdCwgcHJvcHM6IFByb3BzKSA9PiB7XG4gIGNvbnN0IGRhdGFiYXNlU2VjdXJpdHlHcm91cCA9IGNyZWF0ZVNlY3VyaXR5R3JvdXAoc2NvcGUsIHtcbiAgICBpZGVudGlmaWVyOiAnRGF0YWJhc2VTZWN1cml0eUdyb3VwJyxcbiAgICBkZXNjcmlwdGlvbjogJ0RhdGFiYXNlIFNlY3VyaXR5IEdyb3VwJyxcbiAgICB2cGM6IHByb3BzLnZwYyxcbiAgfSlcblxuICBjb25zdCBkYXRhYmFzZSA9IG5ldyByZHMuRGF0YWJhc2VJbnN0YW5jZShzY29wZSwgYERhdGFiYXNlYCwge1xuICAgIC8vIHNob3VsZCBiZSB0cnVlIGJ1dCBJJ20gcmV0YXJkZWQgYW5kXG4gICAgLy8gd2lsbCBwcm9iYWJseSBuZWVkIHRvIHNlZSB0aGUgcHJvZCBkYiB0byBkZWJ1ZyBkdW1iYXNzIHVzZXIgcHJvYmxlbXNcbiAgICBzdG9yYWdlRW5jcnlwdGVkOiBmYWxzZSxcblxuICAgIC8vIFJEUyBJTlNUQU5DRSBTRVRUSU5HU1xuICAgIC8vIG9wdGlvbmFsLCBkZWZhdWx0cyB0byBtNS5sYXJnZSh3aGF0IHRoZSBmdWNrPylcbiAgICAvLyBZb3UgZ2V0IGEgc2luZ2xlIHBlcnNpc3RlbnQgZGF0YWJhc2UgdDMubWljcm8gZm9yIGZyZWUgdW5kZXIgYXdzIGZyZWUgdGllclxuICAgIC8vIHQzLm1pY3JvIGdpdmVzIDIgVmNwdSBhbmQgMSBnaWcgb2YgbWVtb3J5XG4gICAgaW5zdGFuY2VUeXBlOiBuZXcgZWMyLkluc3RhbmNlVHlwZSgndDMubWljcm8nKSxcbiAgICAvLyBTZXQgYXMgUG9zdGdyZXNcbiAgICBlbmdpbmU6IHJkcy5EYXRhYmFzZUluc3RhbmNlRW5naW5lLnBvc3RncmVzKHtcbiAgICAgIHZlcnNpb246IHJkcy5Qb3N0Z3Jlc0VuZ2luZVZlcnNpb24uVkVSXzE0XzMsIC8vIE1vc3QgcmVjZW50IHZlcnNpb24gb2YgUG9zdGdyZXMocHJpc21hIHN1cHBvcnRzIGl0KVxuICAgIH0pLFxuICAgIGFsbG93TWFqb3JWZXJzaW9uVXBncmFkZTogZmFsc2UsIC8vIElmIHRydWUsIHdlIG1pZ2h0IGhhdmUgYW4gdXBncmFkZSBtYWRlIHRoYXQgYnJlYWtzIG91ciBPUk1cbiAgICBhdXRvTWlub3JWZXJzaW9uVXBncmFkZTogdHJ1ZSxcbiAgICAvLyBZb3UgZ2V0IDIwR0Igb2Ygc3RvcmFnZSB1bmRlciB0aGUgQVdTIEZyZWUgdGllclxuICAgIGFsbG9jYXRlZFN0b3JhZ2U6IDIwLFxuICAgIG11bHRpQXo6IGZhbHNlLCAvLyBNYWtpbmcgdGhpcyB0cnVlIGlzIFRFQ0hOSUNBTExZIGJldHRlciwgYnV0IGl0IGNvc3Qgd2F5IG1vcmUgbW9uZXlcbiAgICBzdG9yYWdlVHlwZTogcmRzLlN0b3JhZ2VUeXBlLkdQMiwgLy8gcmVxdWlyZWQgZm9yIGZyZWUgdGllclxuXG4gICAgcmVtb3ZhbFBvbGljeTogY2RrLlJlbW92YWxQb2xpY3kuREVTVFJPWSxcbiAgICAvLyBJZiB3ZSBldmVyIGZhdCBmaW5nZXIgYSBjZGsgZGVwbG95IGFuZCBkZWxldGUgb3VyIGRhdGFiYXNlLFxuICAgIC8vIFdlIHdhbnQgb3VyIGJhY2t1cHMgdG8gZXhpc3QuICBFdmVuIGluIGRldi5cbiAgICAvLyBOb3RlIHRoYXQsIGJ5IGRlZmF1bHQsIDEgYmFja3VwIGlzIGNyZWF0ZWQgZXZlcnkgZGF5LlxuICAgIC8vIFRoaXMgYmFja3VwIGlzIGFsc28gb25seSByZXRhaW5lZCBmb3IgMSBkYXksXG4gICAgZGVsZXRlQXV0b21hdGVkQmFja3VwczogZmFsc2UsXG5cbiAgICAvLyBZb3UgZ2V0IDcgZGF5cyBvZiBmcmVlIHBlcmZvcm1hbmNlIGRhdGFcbiAgICBwZXJmb3JtYW5jZUluc2lnaHRSZXRlbnRpb246IDcsXG4gICAgZW5hYmxlUGVyZm9ybWFuY2VJbnNpZ2h0czogdHJ1ZSxcbiAgICAvLyBPcHRpb25hbCBWYWx1ZXMgYXJlOiAgMSwgNSwgMTAsIDE1LCAzMCwgb3IgNjBcbiAgICAvLyBOb3RlOiAgVGhpcyBpcyBmcmVlIHVudGlsIHlvdSBoaXQgY2xvdWR3YXRjaCBsaW1pdHNcbiAgICBtb25pdG9yaW5nSW50ZXJ2YWw6IER1cmF0aW9uLnNlY29uZHMoMzApLFxuICAgIC8vIEJ5IGRlZmF1bHQsIHRoZSBsb2cgcmV0ZW50aW9uIGlzICdGb3JldmVyJy5cbiAgICAvLyBUbyBrZWVwIHdpdGhpbiB0aGUgZnJlZSB0aWVyLCB3ZSBzZXQgaXQgdG8gNyBkYXlzLlxuICAgIC8vIFBlcmZvcm1hbmNlIG1vbml0b3Jpbmcgc2hvdWxkIGJlIGFuIGFjdGl2ZSB0aGluZyB5b3UgZG9cbiAgICAvLyBkdXJpbmcgcGVhayB0aW1lcy4gIEl0J3Mgbm90IFRIQVQgaW1wb3J0YW50IHRvIGtub3cgcGVyZm9ybWFuY2VcbiAgICAvLyBmcm9tIGEgeWVhciBhZ28uICBNb3N0bHkgeW91IHdhbnQgdG8gbG9vayBhdCB0aGlzIHdoZW5cbiAgICAvLyB5b3VyIHdlYiBhcHBsaWNhdGlvbiBzaGl0cyB0aGUgYmVkIGJlY2F1c2UgeW91IG5ldmVyIGJvdGhlcmVkIHRvXG4gICAgLy8gY2hlY2sgdGhlIGxvZ3MgYW5kIGRpZG4ndCBub3RpY2UgdGhhdCB5b3Ugd2VyZSAxIHVzZXIgYXdheSBmcm9tXG4gICAgLy8gcnVubmluZyBvdXQgb2YgbWVtb3J5L2NwdVxuICAgIGNsb3Vkd2F0Y2hMb2dzUmV0ZW50aW9uOiA3LFxuICAgIGRhdGFiYXNlTmFtZTogcHJvcHMuZGF0YWJhc2VOYW1lLFxuICAgIHZwYzogcHJvcHMudnBjLFxuICAgIHNlY3VyaXR5R3JvdXBzOiBbZGF0YWJhc2VTZWN1cml0eUdyb3VwXSxcbiAgICAvLyBUaGUgY3JlZGVudGlhbHMgbXVzdCBoYXZlIGEgJ3VzZXJuYW1lJyBhbmQgJ3Bhc3N3b3JkJyBwcm9wZXJ0eVxuICAgIHZwY1N1Ym5ldHM6IHtcbiAgICAgIC8vIElmIHlvdSBkb24ndCB3YW50IGEgTkFUIEdhdGV3YXkod2hpY2ggd2UgZG9uJ3QpLCBZb3UgbXVzdCBzZXQgdGhpcy5cbiAgICAgIC8vIElmIHlvdSBkb24ndCBzZXQgdGhpcyBhbmQgeW91IHNldCAnbmF0Z2F0ZXdheXMnIHRvIHplcm8gaW4geW91ciB2cGMsXG4gICAgICAvLyBFdmVyeXRoaW5nIHdpbGwgc2hpdCB0aGUgYmVkIGFuZCBpdCB3aWxsIHNheSAndGhlcmUgYXJlIG5vIHByaXZhdGUgbmV0d29ya3MgaW4geW91ciB2cGMnXG4gICAgICAvLyBGdWNraW5nIGFtYXpvbiBidWxsc2hpdCBhYm91dCB0cmlja2luZyBwZW9wbGUgaW50byBzcGVuZGluZyBtb25leS4gIGZ1Y2tpbmcgZHVtYi5cbiAgICAgIHN1Ym5ldFR5cGU6IGdldFN1Ym5ldFR5cGUoJ3B1YmxpYycpLFxuICAgIH0sXG4gIH0pXG5cbiAgcmV0dXJuIGRhdGFiYXNlXG59XG5cbmNvbnN0IGdldFN1Ym5ldFR5cGUgPSAodHlwZTogc3VibmV0VHlwZSkgPT4ge1xuICBjb25zdCB0eXBlcyA9IGVjMi5TdWJuZXRUeXBlXG4gIGlmICh0eXBlID09PSAncHJpdmF0ZScpIHJldHVybiB0eXBlcy5QUklWQVRFX1dJVEhfRUdSRVNTXG4gIGlmICh0eXBlID09PSAnaXNvbGF0ZWQnKSByZXR1cm4gdHlwZXMuUFJJVkFURV9JU09MQVRFRFxuICByZXR1cm4gdHlwZXMuUFVCTElDXG59XG5cbnR5cGUgREJTZWNyZXRGaWVsZHMgPVxuICB8ICdob3N0J1xuICB8ICdwb3J0J1xuICB8ICdkYmluc3RhbmNlaWRlbnRpZmllcidcbiAgfCAndXNlcm5hbWUnXG4gIHwgJ3Bhc3N3b3JkJ1xuZXhwb3J0IGNvbnN0IGdldERiU2VjcmV0SnNvbiA9XG4gIChkYXRhYmFzZTogRGF0YWJhc2VJbnN0YW5jZSkgPT4gKGZpZWxkOiBEQlNlY3JldEZpZWxkcykgPT4ge1xuICAgIGlmICghZGF0YWJhc2Uuc2VjcmV0KSB0aHJvdyAnTm8gRGF0YWJhc2UgU2VjcmV0IENyZWF0ZWQnXG4gICAgcmV0dXJuIGVjcy5TZWNyZXQuZnJvbVNlY3JldHNNYW5hZ2VyKGRhdGFiYXNlLnNlY3JldCwgZmllbGQpXG4gIH1cblxuLy8gZXhwb3J0IGNvbnN0IGdldFByaXNtYUNvbm5lY3Rpb25EYlVybEZyb21TZWNyZXQgPSAoc2VjcmV0OiBTZWNyZXQpID0+IHtcbi8vICAgY29uc3QgZ2V0U2VjcmV0ID0gZ2V0RGJTZWNyZXRKc29uKHNlY3JldClcbi8vICAgY29uc3QgcGFzc3dvcmQgPSBnZXRTZWNyZXQoJ3Bhc3N3b3JkJylcbi8vICAgY29uc3QgdXNlcm5hbWUgPSBnZXRTZWNyZXQoJ3VzZXJuYW1lJylcbi8vICAgY29uc3QgaG9zdCA9IGdldFNlY3JldCgnaG9zdCcpXG4vLyAgIGNvbnN0IHBvcnQgPSBnZXRTZWNyZXQoJ3BvcnQnKVxuLy8gICBjb25zdCBpZGVudGlmaWVyID0gZ2V0U2VjcmV0KCdkYmluc3RhbmNlaWRlbnRpZmllcicpXG5cbi8vICAgcmV0dXJuIGBwb3N0Z3Jlc3FsOi8vJHt1c2VybmFtZX06JHtwYXNzd29yZH1AJHtob3N0fToke3BvcnR9LyR7aWRlbnRpZmllcn0/c2NoZW1hPXB1YmxpY2Bcbi8vIH1cblxuZXhwb3J0IGNvbnN0IGdldERiTmFtZSA9IChzdGFja05hbWU6IHN0cmluZywgc3RhZ2U6ICdEZXYnIHwgJ1Byb2QnKSA9PlxuICBgJHtzdGFja05hbWV9JHtzdGFnZX1EYXRhYmFzZWBcblxuZXhwb3J0IGNvbnN0IGdldERiRW52aXJvbm1lbnQgPSAoXG4gIGRhdGFiYXNlOiBEYXRhYmFzZUluc3RhbmNlLFxuICBkYk5hbWU6IHN0cmluZyxcbikgPT4ge1xuICBjb25zdCB7IHNvY2tldEFkZHJlc3MsIGhvc3RuYW1lLCBwb3J0IH0gPSBkYXRhYmFzZS5pbnN0YW5jZUVuZHBvaW50XG4gIHJldHVybiB7XG4gICAgREJfSE9TVDogaG9zdG5hbWUsXG4gICAgREJfUE9SVDogcG9ydC50b1N0cmluZygpLFxuICAgIERCX1NPQ0tFVF9BRERSRVNTOiBzb2NrZXRBZGRyZXNzLFxuICAgIERCX05BTUU6IGRiTmFtZSxcbiAgfVxufVxuXG5leHBvcnQgY29uc3QgZ2V0RGJTZWNyZXRzID0gKHNlY3JldD86IElTZWNyZXQpID0+IHtcbiAgaWYgKCFzZWNyZXQpIHJldHVybiB1bmRlZmluZWRcbiAgcmV0dXJuIHtcbiAgICBEQl9VU0VSTkFNRTogZWNzLlNlY3JldC5mcm9tU2VjcmV0c01hbmFnZXIoc2VjcmV0LCAndXNlcm5hbWUnKSxcbiAgICBEQl9QQVNTV09SRDogZWNzLlNlY3JldC5mcm9tU2VjcmV0c01hbmFnZXIoc2VjcmV0LCAncGFzc3dvcmQnKSxcbiAgfVxufVxuIl19